name: Transcribe Audio

on:
  workflow_dispatch:
    inputs:
      audio_file:
        description: 'Path to audio file in repo'
        required: true
        default: 'test-audio/secret-code-ru.ogg'
      language:
        description: 'Language code (ru, en, etc.)'
        required: true
        default: 'ru'
      run_id:
        description: 'Unique run identifier (auto-generated if empty)'
        required: false
        default: ''

permissions:
  contents: write

env:
  # Generate unique run ID if not provided
  RUN_ID: ${{ inputs.run_id || github.run_id }}

jobs:
  transcribe:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install assemblyai
      
      - name: Create output directory
        run: mkdir -p "test-results/run-${{ env.RUN_ID }}"
      
      - name: Transcribe audio
        env:
          ASSEMBLYAI_API_KEY: ${{ secrets.ASSEMBLYAI_API_KEY }}
        run: |
          python << 'EOF'
          import assemblyai as aai
          import os
          import re
          import json
          from datetime import datetime
          
          run_id = os.environ.get("RUN_ID", "unknown")
          output_dir = f"test-results/run-{run_id}"
          
          aai.settings.api_key = os.environ["ASSEMBLYAI_API_KEY"]
          
          config = aai.TranscriptionConfig(language_code="${{ inputs.language }}")
          transcriber = aai.Transcriber()
          
          audio_file = "${{ inputs.audio_file }}"
          print(f"ðŸŽ™ï¸ Transcribing: {audio_file}")
          print(f"ðŸ“ Output dir: {output_dir}")
          
          transcript = transcriber.transcribe(audio_file, config=config)
          
          if transcript.status == aai.TranscriptStatus.error:
              print(f"âŒ Error: {transcript.error}")
              exit(1)
          
          print(f"ðŸ“ Full text: {transcript.text}")
          
          # Extract numeric code
          numbers = re.findall(r'\d+', transcript.text)
          code = numbers[0] if numbers else "NO_CODE_FOUND"
          print(f"ðŸ” Secret code: {code}")
          
          # Save results
          with open(f"{output_dir}/secret-code.txt", "w") as f:
              f.write(code)
          
          with open(f"{output_dir}/transcript.txt", "w") as f:
              f.write(transcript.text)
          
          # Save metadata
          metadata = {
              "run_id": run_id,
              "audio_file": audio_file,
              "language": "${{ inputs.language }}",
              "timestamp": datetime.utcnow().isoformat(),
              "secret_code": code,
              "full_text": transcript.text
          }
          with open(f"{output_dir}/metadata.json", "w") as f:
              json.dump(metadata, f, indent=2, ensure_ascii=False)
          
          print(f"âœ… Results saved to {output_dir}/")
          EOF
      
      - name: Save terminal log
        run: |
          OUTPUT_DIR="test-results/run-${{ env.RUN_ID }}"
          {
            echo "=== Transcription Log ==="
            echo "Run ID: ${{ env.RUN_ID }}"
            echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Audio: ${{ inputs.audio_file }}"
            echo "Language: ${{ inputs.language }}"
            echo "Workflow: ${{ github.workflow }}"
            echo "Commit: ${{ github.sha }}"
            echo ""
            echo "=== Result ==="
            cat "$OUTPUT_DIR/secret-code.txt"
          } > "$OUTPUT_DIR/terminal.log"
      
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add test-results/
          git commit -m "test: transcription run-${{ env.RUN_ID }} [automated]"
          git push
      
      - name: Summary
        run: |
          OUTPUT_DIR="test-results/run-${{ env.RUN_ID }}"
          echo "## ðŸŽ‰ Transcription Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | \`${{ env.RUN_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Audio | \`${{ inputs.audio_file }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Language | \`${{ inputs.language }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Code | \`$(cat $OUTPUT_DIR/secret-code.txt)\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files" >> $GITHUB_STEP_SUMMARY
          echo "- [\`$OUTPUT_DIR/secret-code.txt\`](../blob/main/$OUTPUT_DIR/secret-code.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`$OUTPUT_DIR/transcript.txt\`](../blob/main/$OUTPUT_DIR/transcript.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- [\`$OUTPUT_DIR/metadata.json\`](../blob/main/$OUTPUT_DIR/metadata.json)" >> $GITHUB_STEP_SUMMARY
